/**
 * @license
 * Copyright Akveo. All Rights Reserved.
 * Licensed under the MIT License. See License.txt in the project root for license information.
 */
import { Inject, Injectable, Optional } from '@angular/core';
import { NB_SECURITY_OPTIONS_TOKEN } from '../security.options';
import * as i0 from "@angular/core";
const shallowObjectClone = (o) => Object.assign({}, o);
const shallowArrayClone = (a) => Object.assign([], a);
const popParent = (abilities) => {
    const parent = abilities.parent;
    delete abilities.parent;
    return parent;
};
/**
 * Common acl service.
 */
export class NbAclService {
    constructor(settings = {}) {
        this.settings = settings;
        this.state = {};
        if (settings.accessControl) {
            this.setAccessControl(settings.accessControl);
        }
    }
    /**
     * Set/Reset ACL list
     * @param {NbAccessControl} list
     */
    setAccessControl(list) {
        for (const [role, value] of Object.entries(list)) {
            const abilities = shallowObjectClone(value);
            const parent = popParent(abilities);
            this.register(role, parent, abilities);
        }
    }
    /**
     * Register a new role with a list of abilities (permission/resources combinations)
     * @param {string} role
     * @param {string} parent
     * @param {[permission: string]: string|string[]} abilities
     */
    register(role, parent = null, abilities = {}) {
        this.validateRole(role);
        this.state[role] = {
            parent: parent,
        };
        for (const [permission, value] of Object.entries(abilities)) {
            const resources = typeof value === 'string' ? [value] : value;
            this.allow(role, permission, shallowArrayClone(resources));
        }
    }
    /**
     * Allow a permission for specific resources to a role
     * @param {string} role
     * @param {string} permission
     * @param {string | string[]} resource
     */
    allow(role, permission, resource) {
        this.validateRole(role);
        if (!this.getRole(role)) {
            this.register(role, null, {});
        }
        resource = typeof resource === 'string' ? [resource] : resource;
        let resources = shallowArrayClone(this.getRoleResources(role, permission));
        resources = resources.concat(resource);
        this.state[role][permission] = resources.filter((item, pos) => resources.indexOf(item) === pos);
    }
    /**
     * Check whether the role has a permission to a resource
     * @param {string} role
     * @param {string} permission
     * @param {string} resource
     * @returns {boolean}
     */
    can(role, permission, resource) {
        this.validateResource(resource);
        const parentRole = this.getRoleParent(role);
        const parentCan = parentRole && this.can(this.getRoleParent(role), permission, resource);
        return parentCan || this.exactCan(role, permission, resource);
    }
    getRole(role) {
        return this.state[role];
    }
    validateRole(role) {
        if (!role) {
            throw new Error('NbAclService: role name cannot be empty');
        }
    }
    validateResource(resource) {
        if (!resource || [NbAclService.ANY_RESOURCE].includes(resource)) {
            throw new Error(`NbAclService: cannot use empty or bulk '*' resource placeholder with 'can' method`);
        }
    }
    exactCan(role, permission, resource) {
        const resources = this.getRoleResources(role, permission);
        return resources.includes(resource) || resources.includes(NbAclService.ANY_RESOURCE);
    }
    getRoleResources(role, permission) {
        return this.getRoleAbilities(role)[permission] || [];
    }
    getRoleAbilities(role) {
        const abilities = shallowObjectClone(this.state[role] || {});
        popParent(shallowObjectClone(this.state[role] || {}));
        return abilities;
    }
    getRoleParent(role) {
        return this.state[role] ? this.state[role].parent : null;
    }
}
NbAclService.ANY_RESOURCE = '*';
NbAclService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: NbAclService, deps: [{ token: NB_SECURITY_OPTIONS_TOKEN, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
NbAclService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: NbAclService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: NbAclService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [NB_SECURITY_OPTIONS_TOKEN]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWNsLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvZnJhbWV3b3JrL3NlY3VyaXR5L3NlcnZpY2VzL2FjbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFDSCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0QsT0FBTyxFQUFFLHlCQUF5QixFQUE0QyxNQUFNLHFCQUFxQixDQUFDOztBQUUxRyxNQUFNLGtCQUFrQixHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUN2RCxNQUFNLGlCQUFpQixHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUN0RCxNQUFNLFNBQVMsR0FBRyxDQUFDLFNBQVMsRUFBRSxFQUFFO0lBQzlCLE1BQU0sTUFBTSxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUM7SUFDaEMsT0FBTyxTQUFTLENBQUMsTUFBTSxDQUFDO0lBQ3hCLE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMsQ0FBQztBQUVGOztHQUVHO0FBRUgsTUFBTSxPQUFPLFlBQVk7SUFLdkIsWUFBcUUsV0FBeUIsRUFBRTtRQUEzQixhQUFRLEdBQVIsUUFBUSxDQUFtQjtRQUZ4RixVQUFLLEdBQW9CLEVBQUUsQ0FBQztRQUdsQyxJQUFJLFFBQVEsQ0FBQyxhQUFhLEVBQUU7WUFDMUIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUMvQztJQUNILENBQUM7SUFFRDs7O09BR0c7SUFDSCxnQkFBZ0IsQ0FBQyxJQUFxQjtRQUNwQyxLQUFLLE1BQU0sQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxD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WSxrQkFLUyx5QkFBeUI7OEdBTDlDLFlBQVk7NEZBQVosWUFBWTtrQkFEeEIsVUFBVTs7MEJBTUksUUFBUTs7MEJBQUksTUFBTTsyQkFBQyx5QkFBeUIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgQWt2ZW8uIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuIFNlZSBMaWNlbnNlLnR4dCBpbiB0aGUgcHJvamVjdCByb290IGZvciBsaWNlbnNlIGluZm9ybWF0aW9uLlxuICovXG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOQl9TRUNVUklUWV9PUFRJT05TX1RPS0VOLCBOYkFjbE9wdGlvbnMsIE5iQWNsUm9sZSwgTmJBY2Nlc3NDb250cm9sIH0gZnJvbSAnLi4vc2VjdXJpdHkub3B0aW9ucyc7XG5cbmNvbnN0IHNoYWxsb3dPYmplY3RDbG9uZSA9IChvKSA9PiBPYmplY3QuYXNzaWduKHt9LCBvKTtcbmNvbnN0IHNoYWxsb3dBcnJheUNsb25lID0gKGEpID0+IE9iamVjdC5hc3NpZ24oW10sIGEpO1xuY29uc3QgcG9wUGFyZW50ID0gKGFiaWxpdGllcykgPT4ge1xuICBjb25zdCBwYXJlbnQgPSBhYmlsaXRpZXMucGFyZW50O1xuICBkZWxldGUgYWJpbGl0aWVzLnBhcmVudDtcbiAgcmV0dXJuIHBhcmVudDtcbn07XG5cbi8qKlxuICogQ29tbW9uIGFjbCBzZXJ2aWNlLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTmJBY2xTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgQU5ZX1JFU09VUkNFID0gJyonO1xuXG4gIHByaXZhdGUgc3RhdGU6IE5iQWNjZXNzQ29udHJvbCA9IHt9O1xuXG4gIGNvbnN0cnVjdG9yKEBPcHRpb25hbCgpIEBJbmplY3QoTkJfU0VDVVJJVFlfT1BUSU9OU19UT0tFTikgcHJvdGVjdGVkIHNldHRpbmdzOiBOYkFjbE9wdGlvbnMgPSB7fSkge1xuICAgIGlmIChzZXR0aW5ncy5hY2Nlc3NDb250cm9sKSB7XG4gICAgICB0aGlzLnNldEFjY2Vzc0NvbnRyb2woc2V0dGluZ3MuYWNjZXNzQ29udHJvbCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldC9SZXNldCBBQ0wgbGlzdFxuICAgKiBAcGFyYW0ge05iQWNjZXNzQ29udHJvbH0gbGlzdFxuICAgKi9cbiAgc2V0QWNjZXNzQ29udHJvbChsaXN0OiBOYkFjY2Vzc0NvbnRyb2wpIHtcbiAgICBmb3IgKGNvbnN0IFtyb2xlLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMobGlzdCkpIHtcbiAgICAgIGNvbnN0IGFiaWxpdGllcyA9IHNoYWxsb3dPYmplY3RDbG9uZSh2YWx1ZSk7XG4gICAgICBjb25zdCBwYXJlbnQgPSBwb3BQYXJlbnQoYWJpbGl0aWVzKTtcbiAgICAgIHRoaXMucmVnaXN0ZXIocm9sZSwgcGFyZW50LCBhYmlsaXRpZXMpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RlciBhIG5ldyByb2xlIHdpdGggYSBsaXN0IG9mIGFiaWxpdGllcyAocGVybWlzc2lvbi9yZXNvdXJjZXMgY29tYmluYXRpb25zKVxuICAgKiBAcGFyYW0ge3N0cmluZ30gcm9sZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gcGFyZW50XG4gICAqIEBwYXJhbSB7W3Blcm1pc3Npb246IHN0cmluZ106IHN0cmluZ3xzdHJpbmdbXX0gYWJpbGl0aWVzXG4gICAqL1xuICByZWdpc3Rlcihyb2xlOiBzdHJpbmcsIHBhcmVudDogc3RyaW5nID0gbnVsbCwgYWJpbGl0aWVzOiB7IFtwZXJtaXNzaW9uOiBzdHJpbmddOiBzdHJpbmcgfCBzdHJpbmdbXSB9ID0ge30pIHtcbiAgICB0aGlzLnZhbGlkYXRlUm9sZShyb2xlKTtcblxuICAgIHRoaXMuc3RhdGVbcm9sZV0gPSB7XG4gICAgICBwYXJlbnQ6IHBhcmVudCxcbiAgICB9O1xuXG4gICAgZm9yIChjb25zdCBbcGVybWlzc2lvbiwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGFiaWxpdGllcykpIHtcbiAgICAgIGNvbnN0IHJlc291cmNlcyA9IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBbdmFsdWVdIDogdmFsdWU7XG4gICAgICB0aGlzLmFsbG93KHJvbGUsIHBlcm1pc3Npb24sIHNoYWxsb3dBcnJheUNsb25lKHJlc291cmNlcykpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBbGxvdyBhIHBlcm1pc3Npb24gZm9yIHNwZWNpZmljIHJlc291cmNlcyB0byBhIHJvbGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IHJvbGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBlcm1pc3Npb25cbiAgICogQHBhcmFtIHtzdHJpbmcgfCBzdHJpbmdbXX0gcmVzb3VyY2VcbiAgICovXG4gIGFsbG93KHJvbGU6IHN0cmluZywgcGVybWlzc2lvbjogc3RyaW5nLCByZXNvdXJjZTogc3RyaW5nIHwgc3RyaW5nW10pIHtcbiAgICB0aGlzLnZhbGlkYXRlUm9sZShyb2xlKTtcblxuICAgIGlmICghdGhpcy5nZXRSb2xlKHJvbGUpKSB7XG4gICAgICB0aGlzLnJlZ2lzdGVyKHJvbGUsIG51bGwsIHt9KTtcbiAgICB9XG5cbiAgICByZXNvdXJjZSA9IHR5cGVvZiByZXNvdXJjZSA9PT0gJ3N0cmluZycgPyBbcmVzb3VyY2VdIDogcmVzb3VyY2U7XG5cbiAgICBsZXQgcmVzb3VyY2VzID0gc2hhbGxvd0FycmF5Q2xvbmUodGhpcy5nZXRSb2xlUmVzb3VyY2VzKHJvbGUsIHBlcm1pc3Npb24pKTtcbiAgICByZXNvdXJjZXMgPSByZXNvdXJjZXMuY29uY2F0KHJlc291cmNlKTtcblxuICAgIHRoaXMuc3RhdGVbcm9sZV1bcGVybWlzc2lvbl0gPSByZXNvdXJjZXMuZmlsdGVyKChpdGVtLCBwb3MpID0+IHJlc291cmNlcy5pbmRleE9mKGl0ZW0pID09PSBwb3MpO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIHdoZXRoZXIgdGhlIHJvbGUgaGFzIGEgcGVybWlzc2lvbiB0byBhIHJlc291cmNlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSByb2xlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwZXJtaXNzaW9uXG4gICAqIEBwYXJhbSB7c3RyaW5nfSByZXNvdXJjZVxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICovXG4gIGNhbihyb2xlOiBzdHJpbmcsIHBlcm1pc3Npb246IHN0cmluZywgcmVzb3VyY2U6IHN0cmluZykge1xuICAgIHRoaXMudmFsaWRhdGVSZXNvdXJjZShyZXNvdXJjZSk7XG5cbiAgICBjb25zdCBwYXJlbnRSb2xlID0gdGhpcy5nZXRSb2xlUGFyZW50KHJvbGUpO1xuICAgIGNvbnN0IHBhcmVudENhbiA9IHBhcmVudFJvbGUgJiYgdGhpcy5jYW4odGhpcy5nZXRSb2xlUGFyZW50KHJvbGUpLCBwZXJtaXNzaW9uLCByZXNvdXJjZSk7XG4gICAgcmV0dXJuIHBhcmVudENhbiB8fCB0aGlzLmV4YWN0Q2FuKHJvbGUsIHBlcm1pc3Npb24sIHJlc291cmNlKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Um9sZShyb2xlOiBzdHJpbmcpOiBOYkFjbFJvbGUge1xuICAgIHJldHVybiB0aGlzLnN0YXRlW3JvbGVdO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZVJvbGUocm9sZTogc3RyaW5nKSB7XG4gICAgaWYgKCFyb2xlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05iQWNsU2VydmljZTogcm9sZSBuYW1lIGNhbm5vdCBiZSBlbXB0eScpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdmFsaWRhdGVSZXNvdXJjZShyZXNvdXJjZTogc3RyaW5nKSB7XG4gICAgaWYgKCFyZXNvdXJjZSB8fCBbTmJBY2xTZXJ2aWNlLkFOWV9SRVNPVVJDRV0uaW5jbHVkZXMocmVzb3VyY2UpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5iQWNsU2VydmljZTogY2Fubm90IHVzZSBlbXB0eSBvciBidWxrICcqJyByZXNvdXJjZSBwbGFjZWhvbGRlciB3aXRoICdjYW4nIG1ldGhvZGApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZXhhY3RDYW4ocm9sZTogc3RyaW5nLCBwZXJtaXNzaW9uOiBzdHJpbmcsIHJlc291cmNlOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZXNvdXJjZXMgPSB0aGlzLmdldFJvbGVSZXNvdXJjZXMocm9sZSwgcGVybWlzc2lvbik7XG4gICAgcmV0dXJuIHJlc291cmNlcy5pbmNsdWRlcyhyZXNvdXJjZSkgfHwgcmVzb3VyY2VzLmluY2x1ZGVzKE5iQWNsU2VydmljZS5BTllfUkVTT1VSQ0UpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSb2xlUmVzb3VyY2VzKHJvbGU6IHN0cmluZywgcGVybWlzc2lvbjogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIHJldHVybiB0aGlzLmdldFJvbGVBYmlsaXRpZXMocm9sZSlbcGVybWlzc2lvbl0gfHwgW107XG4gIH1cblxuICBwcml2YXRlIGdldFJvbGVBYmlsaXRpZXMocm9sZTogc3RyaW5nKTogeyBbcGVybWlzc2lvbjogc3RyaW5nXTogc3RyaW5nW10gfSB7XG4gICAgY29uc3QgYWJpbGl0aWVzID0gc2hhbGxvd09iamVjdENsb25lKHRoaXMuc3RhdGVbcm9sZV0gfHwge30pO1xuICAgIHBvcFBhcmVudChzaGFsbG93T2JqZWN0Q2xvbmUodGhpcy5zdGF0ZVtyb2xlXSB8fCB7fSkpO1xuICAgIHJldHVybiBhYmlsaXRpZXM7XG4gIH1cblxuICBwcml2YXRlIGdldFJvbGVQYXJlbnQocm9sZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZVtyb2xlXSA/IHRoaXMuc3RhdGVbcm9sZV0ucGFyZW50IDogbnVsbDtcbiAgfVxufVxuIl19